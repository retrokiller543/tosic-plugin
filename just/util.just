# Variables with default values
profile := env_var_or_default("PROFILE", "debug")
target := env_var_or_default("TARGET", "")
features := env_var_or_default("FEATURES", "")
verbose := env_var_or_default("VERBOSE", "0")
jobs := env_var_or_default("JOBS", "")

# Utility Commands
# ================
# Project management and utility commands

# === Cleanup Commands ===

# ğŸ§¹ Clean all build artifacts
clean-all:
    @echo "ğŸ§¹ Cleaning all build artifacts..."
    cargo clean
    @echo "âœ… All artifacts cleaned"

# ğŸ§¹ Clean build artifacts but keep dependencies
clean-builds:
    @echo "ğŸ§¹ Cleaning build artifacts (keeping dependencies)..."
    find target -name "tosic-plugin*" -type f -delete 2>/dev/null || true
    find target -name "deps" -type d -exec find {} -name "tosic_plugin*" -delete \; 2>/dev/null || true
    @echo "âœ… Build artifacts cleaned"

# ğŸ§¹ Clean documentation
clean-docs:
    @echo "ğŸ§¹ Cleaning documentation..."
    cargo clean --doc
    @echo "âœ… Documentation cleaned"

# ğŸ§¹ Clean test artifacts
clean-tests:
    @echo "ğŸ§¹ Cleaning test artifacts..."
    find . -name "*.profraw" -delete 2>/dev/null || true
    find target -name "*test*" -type f -delete 2>/dev/null || true
    @echo "âœ… Test artifacts cleaned"

# ğŸ§¹ Deep clean (everything including registry cache)
clean-deep:
    @echo "ğŸ§¹ Deep cleaning (including registry cache)..."
    cargo clean
    rm -rf ~/.cargo/registry/cache
    rm -rf ~/.cargo/git/db
    @echo "âœ… Deep clean completed"

# === Project Information ===

# ğŸ“Š Show project status
status:
    @echo "ğŸ“Š Tosic Plugin Project Status"
    @echo "=============================="
    @echo ""
    @echo "ğŸ“ Project Structure:"
    @tree crates/ -I target -L 2 2>/dev/null || find crates/ -type d -not -path "*/target/*" | head -10
    @echo ""
    @echo "ğŸ“¦ Workspace Packages:"
    @cargo metadata --format-version 1 --no-deps | grep '"name"' | head -10
    @echo ""
    @echo "ğŸ”§ Rust Toolchain:"
    @rustc --version
    @cargo --version
    @echo ""
    @echo "ğŸ¯ Git Status:"
    @git status --porcelain | head -10 || echo "Not a git repository"

# ğŸ“‹ Show dependency information
deps:
    @echo "ğŸ“‹ Dependency Information"
    @echo "========================"
    @echo ""
    @echo "ğŸŒ³ Dependency Tree (top level):"
    @cargo tree --depth 1
    @echo ""
    @echo "ğŸ“Š Dependency Statistics:"
    @cargo tree --format '{p}' | sort | uniq | wc -l | xargs echo "Total unique dependencies:"

# ğŸ“‹ Show detailed dependency info
deps-detailed:
    @echo "ğŸ“‹ Detailed Dependency Information"
    @echo "=================================="
    @echo ""
    @echo "ğŸŒ³ Full Dependency Tree:"
    @cargo tree
    @echo ""
    @echo "ğŸ”„ Duplicate Dependencies:"
    @cargo tree --duplicates

# ğŸ¯ Show build targets
targets:
    @echo "ğŸ¯ Available Build Targets"
    @echo "========================="
    @echo ""
    @echo "ğŸ¦€ Installed Rust Targets:"
    @rustup target list --installed
    @echo ""
    @echo "ğŸ“± Default Target:"
    @rustc -vV | grep host

# === Environment Information ===

# ğŸŒ Show environment information
env:
    @echo "ğŸŒ Environment Information"
    @echo "========================="
    @echo ""
    @echo "ğŸ¦€ Rust Environment:"
    @rustc --version
    @cargo --version
    @rustup --version
    @echo ""
    @echo "ğŸ”§ Rustup Toolchains:"
    @rustup toolchain list
    @echo ""
    @echo "ğŸ“¦ Cargo Configuration:"
    @cargo config get || echo "No custom cargo config"
    @echo ""
    @echo "ğŸŒ Environment Variables:"
    @env | grep -E "^(RUST|CARGO)" | sort

# ğŸ›ï¸ Show build configuration
config:
    @echo "ğŸ›ï¸ Build Configuration"
    @echo "====================="
    @echo ""
    @echo "Current settings:"
    @echo "  Profile: {{profile}}"
    @echo "  Target: {{if target != "" { target } else { "native" }}}"
    @echo "  Features: {{if features != "" { features } else { "default" }}}"
    @echo "  Verbose: {{verbose}}"
    @echo "  Jobs: {{if jobs != "" { jobs } else { "auto" }}}"
    @echo ""
    @echo "Override with environment variables:"
    @echo "  PROFILE=release just build"
    @echo "  TARGET=aarch64-apple-darwin just build"
    @echo "  FEATURES=serde just build"
    @echo "  VERBOSE=2 just build"
    @echo "  JOBS=4 just build"

# === Development Utilities ===

# ğŸ”„ Update dependencies
update:
    @echo "ğŸ”„ Updating dependencies..."
    cargo update
    @echo "âœ… Dependencies updated"

# ğŸ”„ Update specific dependency
update-dep dep:
    @echo "ğŸ”„ Updating dependency: {{dep}}"
    cargo update --package "{{dep}}"
    @echo "âœ… Dependency {{dep}} updated"

# ğŸ“ Add dependency
add-dep dep *features="":
    #!/usr/bin/env bash
    echo "ğŸ“ Adding dependency: {{dep}}"
    if [ "{{features}}" != "" ]; then
        cargo add {{dep}} --features "{{features}}"
    else
        cargo add {{dep}}
    fi
    echo "âœ… Dependency {{dep}} added"

# ğŸ“ Add development dependency
add-dev-dep dep *features="":
    #!/usr/bin/env bash
    echo "ğŸ“ Adding development dependency: {{dep}}"
    if [ "{{features}}" != "" ]; then
        cargo add {{dep}} --dev --features "{{features}}"
    else
        cargo add {{dep}} --dev
    fi
    echo "âœ… Development dependency {{dep}} added"

# ğŸ—‘ï¸ Remove dependency
remove-dep dep:
    @echo "ğŸ—‘ï¸ Removing dependency: {{dep}}"
    cargo remove {{dep}}
    @echo "âœ… Dependency {{dep}} removed"

# === Version Management ===

# ğŸ“ˆ Show version information
version:
    #!/usr/bin/env bash
    echo "ğŸ“ˆ Version Information"
    echo "====================="
    echo ""
    grep -r "version" crates/*/Cargo.toml | grep -v "rust-version" | head -10
    echo ""
    echo "Git information:"
    git describe --tags --always 2>/dev/null || echo "No git tags found"
    git rev-parse --short HEAD 2>/dev/null || echo "Not a git repository"

# ğŸ“ˆ Set version for all crates
set-version new_version:
    #!/usr/bin/env bash
    echo "ğŸ“ˆ Setting version to {{new_version}} for all crates..."
    sed -i.bak 's/version = "[^"]*"/version = "{{new_version}}"/' Cargo.toml
    find crates -name Cargo.toml -exec sed -i.bak 's/version = "[^"]*"/version = "{{new_version}}"/' {} \;
    find . -name "*.bak" -delete
    echo "âœ… Version updated to {{new_version}}"

# === File Operations ===

# ğŸ” Find files by pattern
find-files pattern:
    @echo "ğŸ” Finding files matching: {{pattern}}"
    @find . -name "{{pattern}}" -not -path "./target/*" -not -path "./.git/*"

# ğŸ” Search in source files
search term:
    #!/usr/bin/env bash
    echo "ğŸ” Searching for: {{term}}"
    grep -r "{{term}}" crates/ --include="*.rs" || echo "No matches found"

# ğŸ” Search and replace in source files
replace old new:
    #!/usr/bin/env bash
    echo "ğŸ” Replacing '{{old}}' with '{{new}}' in source files..."
    find crates/ -name "*.rs" -exec sed -i.bak 's/{{old}}/{{new}}/g' {} \;
    find . -name "*.bak" -delete
    echo "âœ… Replacement completed"

# === Git Utilities ===

# ğŸ“ Initialize git repository with basic setup
git-init:
    @echo "ğŸ“ Initializing git repository..."
    @if [ ! -d .git ]; then \
        git init; \
        echo "target/" > .gitignore; \
        echo "Cargo.lock" >> .gitignore; \
        echo "**/*.rs.bk" >> .gitignore; \
        echo ".env" >> .gitignore; \
        git add .; \
        git commit -m "Initial commit"; \
        echo "âœ… Git repository initialized"; \
    else \
        echo "âš ï¸ Git repository already exists"; \
    fi

# ğŸ“Š Show git statistics
git-stats:
    #!/usr/bin/env bash
    echo "ğŸ“Š Git Statistics"
    echo "================"
    echo ""
    echo "ğŸ“ˆ Commit Count:"
    git rev-list --count HEAD 2>/dev/null || echo "Not a git repository"
    echo ""
    echo "ğŸ‘¥ Contributors:"
    git shortlog -sn 2>/dev/null || echo "Not a git repository"
    echo ""
    echo "ğŸ“… Recent Activity:"
    git log --oneline -10 2>/dev/null || echo "Not a git repository"

# === Performance Analysis ===

# âš¡ Analyze build performance
perf-build:
    #!/usr/bin/env bash
    echo "âš¡ Analyzing build performance..."
    time cargo build --timings
    echo "ğŸ“Š Check target/cargo-timings/ for detailed timing reports"

# âš¡ Analyze binary size
perf-size:
    @echo "âš¡ Analyzing binary sizes..."
    @if [ -d target/release ]; then \
        find target/release -name "tosic*" -type f -exec ls -lh {} \; 2>/dev/null || echo "No release binaries found"; \
    else \
        echo "No release build found. Run 'just release' first"; \
    fi

# === Workspace Management ===

# ğŸ—ï¸ Create new crate in workspace
new-crate name:
    #!/usr/bin/env bash
    echo "ğŸ—ï¸ Creating new crate: {{name}}"
    mkdir -p crates/{{name}}
    cd crates/{{name}} && cargo init --lib

    # Add to workspace members in root Cargo.toml
    if grep -q "members = \[" Cargo.toml; then
        sed -i.bak '/members = \[/a\
    "crates/{{name}}",' Cargo.toml
    else
        echo "" >> Cargo.toml
        echo "[workspace]" >> Cargo.toml
        echo "members = [" >> Cargo.toml
        echo '    "crates/{{name}}",' >> Cargo.toml
        echo "]" >> Cargo.toml
    fi

    find . -name "*.bak" -delete
    echo "âœ… Crate {{name}} created in crates/{{name}}"

# ğŸ“‹ List workspace crates
list-crates:
    @echo "ğŸ“‹ Workspace Crates"
    @echo "=================="
    @echo ""
    @find crates/ -name Cargo.toml -exec grep -H "^name" {} \; | sed 's|crates/||; s|/Cargo.toml:name = |: |; s|"||g'

# === Help and Information ===

# ğŸ“š Show comprehensive utility help
util-help:
    @echo "ğŸ“š Utility Commands Help"
    @echo "======================="
    @echo ""
    @echo "ğŸ§¹ Cleanup:"
    @echo "  clean-all           - Clean all build artifacts"
    @echo "  clean-builds        - Clean builds (keep dependencies)"
    @echo "  clean-docs          - Clean documentation"
    @echo "  clean-deep          - Deep clean including caches"
    @echo ""
    @echo "ğŸ“Š Information:"
    @echo "  status              - Show project status"
    @echo "  deps                - Show dependency information"
    @echo "  targets             - Show build targets"
    @echo "  env                 - Show environment information"
    @echo "  version             - Show version information"
    @echo ""
    @echo "ğŸ”„ Dependencies:"
    @echo "  update              - Update all dependencies"
    @echo "  add-dep <dep>       - Add dependency"
    @echo "  remove-dep <dep>    - Remove dependency"
    @echo ""
    @echo "ğŸ” Search & Files:"
    @echo "  find-files <pat>    - Find files by pattern"
    @echo "  search <term>       - Search in source files"
    @echo "  replace <old> <new> - Search and replace"
    @echo ""
    @echo "ğŸ—ï¸ Workspace:"
    @echo "  new-crate <name>    - Create new crate"
    @echo "  list-crates         - List workspace crates"